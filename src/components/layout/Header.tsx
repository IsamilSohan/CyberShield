
"use client";

import Link from 'next/link';
import { LogOut, LogIn, UserCog } from 'lucide-react'; // UserCog for Admin
import { Button } from '@/components/ui/button';
import { APP_NAME, NAV_LINKS } from '@/lib/constants';
import { usePathname, useRouter } from 'next/navigation';
import { cn } from '@/lib/utils';
import { useState, useEffect } from 'react';
import { auth } from '@/lib/firebase'; // Import Firebase auth
import { onAuthStateChanged, signOut, type User as FirebaseUser } from 'firebase/auth'; // Import onAuthStateChanged and signOut

// Mock admin state - in a real app, this would come from user roles/permissions
// For example, you might fetch user data from Firestore and check an 'isAdmin' field.
const MOCK_IS_ADMIN = true; 

export function Header() {
  const [currentUser, setCurrentUser] = useState<FirebaseUser | null>(null);
  const [isAdmin, setIsAdmin] = useState(false);
  const pathname = usePathname();
  const router = useRouter();

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (user) => {
      setCurrentUser(user);
      if (user) {
        // In a real app, you would fetch user roles here from Firestore
        // For now, we'll use a mock value if a user is logged in.
        // Example: fetch user doc from Firestore users/{user.uid} and check an isAdmin field
        setIsAdmin(MOCK_IS_ADMIN); // This should be replaced with actual role checking
      } else {
        setIsAdmin(false);
      }
    });
    return () => unsubscribe(); // Cleanup subscription on unmount
  }, []);

  const handleLogout = async () => {
    try {
      await signOut(auth);
      router.push('/auth/login'); // Redirect to login after logout
    } catch (error) {
      console.error("Logout error:", error);
      // Handle logout error if needed
    }
  };
  
  const isAuthenticated = !!currentUser;

  return (
    <header className="sticky top-0 z-50 w-full border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60">
      <div className="container flex h-16 items-center justify-between">
        <Link href="/" className="flex items-center gap-2">
          <span className="h-8 w-8 text-primary">
            <svg version="1.0" xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 1024 1024" // Removed pt units, viewBox is unitless
              preserveAspectRatio="xMidYMid meet"
              className="h-full w-full" // Ensure SVG fills the span
              fill="currentColor" // Inherit color from parent's text-primary
            >
              <g transform="translate(0,1024) scale(0.1,-0.1)"
                stroke="none"
                // Removed fill="#000000" from here to allow currentColor to work
              >
                <path d="M2525 7088 c-62 -36 -438 -193 -635 -265 -188 -68 -437 -132 -722
-184 -192 -35 -190 -29 -189 -503 1 -886 170 -1438 590 -1930 144 -169 400
-382 632 -526 136 -85 340 -190 367 -190 26 0 238 105 354 175 51 32 140 91
198 133 577 420 869 901 984 1623 38 234 49 396 50 709 1 356 -5 411 -47 456
-31 32 -39 35 -202 64 -423 76 -740 178 -1164 374 -90 42 -171 76 -180 76 -9
0 -25 -6 -36 -12z m115 -338 c130 -66 508 -205 725 -267 50 -14 177 -47 284
-73 107 -27 197 -54 201 -60 14 -22 19 -297 10 -467 -31 -553 -173 -1012 -416
-1343 -162 -221 -397 -440 -621 -579 -97 -60 -237 -131 -258 -131 -21 0 -120
51 -230 118 -378 230 -702 598 -865 982 -34 80 -87 239 -111 333 -28 107 -68
337 -59 337 3 0 12 -43 19 -95 8 -52 17 -92 21 -90 5 3 6 -3 3 -13 -11 -45 95
-380 173 -542 91 -189 186 -331 337 -502 149 -168 437 -389 626 -480 l85 -40
67 30 c318 141 692 480 891 807 160 265 260 589 313 1015 9 74 24 413 20 445
-2 17 -5 67 -6 111 -1 45 -5 87 -9 94 -5 7 -102 37 -217 65 -196 49 -308 81
-448 127 -86 28 -257 88 -280 98 -119 51 -199 79 -208 73 -5 -3 -7 -2 -4 4 4
6 -21 22 -57 37 -62 27 -64 27 -107 10 -24 -9 -49 -21 -55 -25 -15 -12 -262
-111 -371 -150 -133 -47 -427 -135 -534 -159 -51 -13 -101 -26 -110 -31 -9 -5
-19 -5 -23 -2 -4 4 73 28 171 53 319 84 587 176 838 289 61 27 118 50 128 50
10 1 44 -12 77 -29z m-60 -10 c0 -5 -8 -10 -17 -10 -15 0 -16 2 -3 10 19 12
20 12 20 0z m47 -306 c-3 -3 -12 -4 -19 -1 -8 3 -5 6 6 6 11 1 17 -2 13 -5z
m77 -34 c109 -28 190 -74 272 -155 131 -130 174 -249 174 -482 l0 -143 63 0
c123 0 132 -24 122 -350 -8 -262 -20 -333 -79 -456 -18 -39 -59 -100 -89 -137
-31 -36 -53 -67 -49 -70 4 -2 1 -2 -6 -1 -7 2 -40 -19 -74 -46 -112 -91 -266
-173 -399 -214 l-85 -27 -74 27 c-142 50 -328 157 -419 239 -25 23 -45 34 -53
29 -7 -4 -10 -4 -6 1 4 4 -14 33 -39 64 -59 72 -117 193 -140 290 -14 62 -17
124 -18 339 l0 264 28 24 c24 20 39 24 95 24 l67 0 0 158 c0 134 4 167 23 227
27 87 66 154 131 226 28 31 47 60 43 64 -4 5 -1 5 5 1 7 -4 27 4 46 18 77 59
216 104 328 105 31 1 91 -8 133 -19z m-1329 -25 c-22 -8 -48 -14 -58 -14 -10
-1 -22 -12 -27 -26 -19 -49 -12 -531 9 -672 4 -29 5 -53 1 -53 -26 0 -45 695
-21 738 5 9 29 22 53 28 59 16 92 15 43 -1z m1948 -35 c3 -11 1 -18 -4 -14 -5
3 -9 12 -9 20 0 20 7 17 13 -6z m402 -20 c3 -5 1 -10 -4 -10 -6 0 -11 5 -11
10 0 6 2 10 4 10 3 0 8 -4 11 -10z m-270 -10 c3 -6 -1 -7 -9 -4 -18 7 -21 14
-7 14 6 0 13 -4 16 -10z m-484 -27 c13 -16 12 -17 -3 -4 -17 13 -22 21 -14 21
2 0 10 -8 17 -17z m243 -32 c-6 -6 -11 1 -18 29 l-7 25 15 -25 c8 -14 12 -27
10 -29z m-1609 10 c3 -5 2 -12 -3 -15 -5 -3 -9 1 -9 9 0 17 3 19 12 6z m1720
-11 c10 -11 16 -20 13 -20 -3 0 -13 9 -23 20 -10 11 -16 20 -13 20 3 0 13 -9
23 -20z m450 1 c3 -5 2 -12 -3 -15 -5 -3 -9 1 -9 9 0 17 3 19 12 6z m-2462
-36 c-3 -9 -8 -14 -10 -11 -3 3 -2 9 2 15 9 16 15 13 8 -4z m187 -30 c0 -5 -5
-3 -10 5 -5 8 -10 20 -10 25 0 6 5 3 10 -5 5 -8 10 -19 10 -25z m2160 25 c0
-5 -5 -10 -11 -10 -5 0 -7 5 -4 10 3 6 8 10 11 10 2 0 4 -4 4 -10z m-2070 -44
c-7 -7 -13 -7 -20 0 -6 6 -3 10 10 10 13 0 16 -4 10 -10z m255 -26 c3 -5 2
-10 -4 -10 -5 0 -13 5 -16 10 -3 6 -2 10 4 10 5 0 13 -4 16 -10z m1845 6 c0
-2 -7 -7 -16 -10 -8 -3 -12 -2 -9 4 6 10 25 14 25 6z m-1723 -22 c-3 -3 -12
-4 -19 -1 -8 3 -5 6 6 6 11 1 17 -2 13 -5z m1431 -19 c-3 -3 -9 2 -12 12 -6
14 -5 15 5 6 7 -7 10 -15 7 -18z m-1988 11 c0 -2 -7 -7 -16 -10 -8 -3 -12 -2
-9 4 6 10 25 14 25 6z m2186 -31 c9 -8 11 -15 6 -15 -5 0 -15 7 -22 15 -7 8
-9 15 -6 15 4 0 14 -7 22 -15z m-1711 -13 c-3 -3 -11 0 -18 7 -9 10 -8 11 6 5
10 -3 15 -9 12 -12z m1610 -22 c3 -6 -1 -7 -9 -4 -18 7 -21 14 -7 14 6 0 13
-4 16 -10z m-1502 -65 c-3 -9 -8 -14 -10 -11 -3 3 -2 9 2 15 9 16 15 13 8 -4z
m1532 -45 c3 -5 1 -10 -4 -10 -6 0 -11 5 -11 10 0 6 2 10 4 10 3 0 8 -4 11
-10z m-35 -40 c0 -5 -5 -10 -11 -10 -5 0 -7 5 -4 10 3 6 8 10 11 10 2 0 4 -4
4 -10z m-1513 -32 c-3 -7 -5 -2 -5 12 0 14 2 19 5 13 2 -7 2 -19 0 -25z m1601
-3 c-3 -3 -9 2 -12 12 -6 14 -5 15 5 6 7 -7 10 -15 7 -18z m-1705 0 c-3 -9 -8
-14 -10 -11 -3 3 -2 9 2 15 9 16 15 13 8 -4z m-413 -19 c0 -3 -4 -8 -10 -11
-5 -3 -10 -1 -10 4 0 6 5 11 10 11 6 0 10 -2 10 -4z m210 -40 c0 -2 -7 -7 -16
-10 -8 -3 -12 -2 -9 4 6 10 25 14 25 6z m2020 -56 c0 -5 -8 -10 -17 -10 -15 0
-16 2 -3 10 19 12 20 12 20 0z m-1713 -47 c-3 -10 -5 -2 -5 17 0 19 2 27 5 18
2 -10 2 -26 0 -35z m-200 1 c-3 -3 -12 -4 -19 -1 -8 3 -5 6 6 6 11 1 17 -2 13
-5z m200 -61 c-3 -10 -5 -4 -5 12 0 17 2 24 5 18 2 -7 2 -21 0 -30z m-514 -58
c-3 -9 -8 -14 -10 -11 -3 3 -2 9 2 15 9 16 15 13 8 -4z m2152 -25 c3 -5 1 -10
-4 -10 -6 0 -11 5 -11 10 0 6 2 10 4 10 3 0 8 -4 11 -10z m-1825 -65 c0 -8 -4
-15 -10 -15 -5 0 -7 7 -4 15 4 8 8 15 10 15 2 0 4 -7 4 -15z m1567 -147 c-3
-8 -6 -5 -6 6 -1 11 2 17 5 13 3 -3 4 -12 1 -19z m170 -23 c0 -8 -4 -12 -9 -9
-5 3 -6 10 -3 15 9 13 12 11 12 -6z m-1832 -83 c-3 -3 -11 0 -18 7 -9 10 -8
11 6 5 10 -3 15 -9 12 -12z m92 -29 c-3 -10 -5 -4 -5 12 0 17 2 24 5 18 2 -7
2 -21 0 -30z m1803 13 c0 -2 -8 -10 -17 -17 -16 -13 -17 -12 -4 4 13 16 21 21
21 13z m-1915 -205 c3 -5 2 -12 -3 -15 -5 -3 -9 1 -9 9 0 17 3 19 12 6z m1608
-216 c-3 -9 -8 -14 -10 -11 -3 3 -2 9 2 15 9 16 15 13 8 -4z m-1313 -389 c0
-2 -8 -10 -17 -17 -16 -13 -17 -12 -4 4 13 16 21 21 21 13z m1174 -72 c3 -8 2
-12 -4 -9 -6 3 -10 10 -10 16 0 14 7 11 14 -7z m-1147 -86 c-3 -8 -6 -5 -6 6
-1 11 2 17 5 13 3 -3 4 -12 1 -19z m558 -18 c-3 -5 -12 -10 -18 -10 -7 0 -6 4
3 10 19 12 23 12 15 0z m-415 -60 c0 -5 -2 -10 -4 -10 -3 0 -8 5 -11 10 -3 6
-1 10 4 10 6 0 11 -4 11 -10z m140 -124 c0 -2 -7 -7 -16 -10 -8 -3 -12 -2 -9
4 6 10 25 14 25 6z m420 -115 c0 -5 -7 -12 -16 -15 -14 -5 -15 -4 -4 9 14 17
20 19 20 6z"/>
                <path d="M2466 6134 c-51 -18 -108 -62 -100 -76 4 -6 2 -8 -4 -5 -14 9 -60
-47 -86 -103 -16 -37 -21 -71 -24 -187 l-4 -143 322 0 322 0 -4 148 c-3 132
-6 152 -28 195 -37 74 -84 123 -152 156 -52 26 -72 31 -132 30 -39 0 -89 -7
-110 -15z m234 -200 c0 -8 -19 -13 -24 -6 -3 5 1 9 9 9 8 0 15 -2 15 -3z m177
-131 c-3 -10 -5 -2 -5 17 0 19 2 27 5 18 2 -10 2 -26 0 -35z m-67 7 c0 -5 -2
-10 -4 -10 -3 0 -8 5 -11 10 -3 6 -1 10 4 10 6 0 11 -4 11 -10z m67 -92 c-3
-7 -5 -2 -5 12 0 14 2 19 5 13 2 -7 2 -19 0 -25z m-457 18 c0 -3 -4 -8 -10
-11 -5 -3 -10 -1 -10 4 0 6 5 11 10 11 6 0 10 -2 10 -4z"/>
                <path d="M2490 5328 c-59 -31 -82 -65 -88 -131 -5 -68 10 -118 49 -157 l30
-29 -21 -116 c-12 -64 -20 -131 -18 -148 l3 -32 116 -3 c93 -2 119 0 128 12
10 12 8 43 -9 151 l-21 135 30 30 c16 17 35 46 41 66 17 49 8 138 -16 172 -26
35 -99 72 -144 72 -20 0 -56 -10 -80 -22z"/>
                <path d="M4941 6559 c-128 -22 -248 -113 -308 -235 -48 -97 -58 -146 -58 -299
0 -117 4 -152 22 -211 43 -136 136 -240 254 -285 168 -64 378 -32 498 76 46
42 100 143 108 204 l6 41 -111 0 c-106 0 -111 -1 -117 -22 -47 -159 -277 -189
-382 -50 -47 62 -67 139 -67 252 0 214 95 342 253 342 35 0 74 -7 95 -17 44
-21 93 -77 101 -117 l7 -28 109 0 c124 0 122 -2 92 86 -48 143 -165 238 -323
263 -74 12 -104 12 -179 0z"/>
                <path d="M5468 6518 c21 -36 172 -313 270 -499 l62 -116 0 -192 0 -191 108 0
107 0 -3 186 -3 185 62 122 c34 67 81 158 104 202 23 44 72 137 109 208 l67
127 -119 0 -118 0 -104 -221 -104 -221 -110 221 -111 221 -118 0 -119 0 20
-32z"/>
                <path d="M6460 6034 l0 -515 263 3 c244 3 266 5 319 26 65 26 128 89 149 148
21 61 17 181 -9 230 -23 46 -80 100 -121 115 -25 10 -25 11 -6 21 35 19 76 62
98 103 16 30 21 58 21 115 1 97 -27 157 -93 205 -78 57 -127 65 -389 65 l-232
0 0 -516z m451 313 c23 -15 37 -35 43 -60 14 -56 -2 -107 -43 -134 -30 -20
-46 -23 -137 -23 l-104 0 0 120 0 120 104 0 c91 0 107 -3 137 -23z m-19 -388
c21 -5 50 -21 65 -34 25 -21 28 -30 28 -88 0 -108 -41 -135 -206 -138 l-104
-2 -3 137 -3 136 93 0 c51 0 110 -5 130 -11z"/>
                <path d="M7360 6035 l0 -515 315 0 315 0 0 95 0 95 -210 0 -210 0 0 115 0 115
190 0 191 0 -3 92 -3 91 -185 1 -185 1 -3 118 -3 117 211 0 210 0 0 95 0 95
-315 0 -315 0 0 -515z"/>
                <path d="M8150 6035 l0 -515 110 0 110 0 0 180 0 180 65 0 65 0 88 -177 89
-178 127 -3 c69 -1 126 -1 126 2 0 2 -49 91 -110 198 -60 106 -110 196 -110
201 0 4 6 7 14 7 34 0 105 71 138 137 30 62 33 75 33 158 -1 74 -5 99 -25 140
-43 89 -124 150 -232 175 -24 5 -143 10 -265 10 l-223 0 0 -515z m452 312 c57
-24 80 -68 76 -144 -3 -53 -8 -67 -33 -93 -37 -39 -79 -50 -187 -50 l-88 0 0
156 0 157 98 -5 c55 -3 113 -12 134 -21z"/>
                <path d="M4812 5225 c-151 -42 -221 -124 -230 -268 -6 -99 10 -155 61 -213 51
-58 106 -85 252 -124 133 -35 167 -50 189 -82 18 -26 21 -80 5 -110 -26 -49
-156 -73 -239 -45 -38 13 -80 67 -80 103 0 24 -1 24 -111 24 l-112 0 7 -42
c19 -123 71 -200 165 -242 81 -36 160 -49 256 -43 151 11 258 69 310 172 27
52 30 68 30 144 -1 100 -19 145 -83 203 -44 40 -101 64 -248 103 -116 32 -145
45 -173 81 -66 84 29 188 157 170 75 -10 102 -33 125 -107 5 -14 23 -17 108
-18 l102 -2 -7 56 c-19 163 -125 244 -331 251 -68 3 -117 -1 -153 -11z"/>
                <path d="M5462 4708 l3 -513 105 0 105 0 0 213 0 212 198 0 197 0 0 -215 0
-215 105 0 105 0 0 515 0 515 -105 0 -105 0 0 -205 0 -205 -200 0 -200 0 0
205 0 205 -105 0 -105 0 2 -512z"/>
                <path d="M6470 4705 l0 -515 110 0 110 0 0 515 0 515 -110 0 -110 0 0 -515z"/>
                <path d="M6880 4705 l0 -515 313 2 312 3 0 94 0 94 -207 1 -208 1 0 118 0 117
188 0 187 0 0 90 0 90 -187 0 -188 0 0 115 0 115 205 0 205 0 0 95 0 95 -310
0 -310 0 0 -515z"/>
                <path d="M7670 4705 l0 -515 300 0 300 0 0 98 0 97 -192 1 -193 1 0 416 0 417
-107 0 -108 0 0 -515z"/>
                <path d="M8410 4704 l0 -516 218 5 c167 3 230 9 272 22 161 51 251 138 307
296 23 63 26 91 27 194 1 178 -32 272 -130 375 -106 111 -211 140 -505 140
l-189 0 0 -516z m476 298 c105 -54 160 -200 135 -354 -29 -177 -116 -252 -305
-265 l-96 -6 0 328 0 327 113 -4 c90 -3 120 -8 153 -26z"/>
              </g>
            </svg>
          </span>
          <span className="text-xl font-bold">{APP_NAME}</span>
        </Link>
        <nav className="flex items-center gap-4">
          {NAV_LINKS.filter(link => 
            (!link.authRequired && !link.publicOnly && !link.adminRequired) ||
            (link.authRequired && isAuthenticated && !link.adminRequired) ||
            (link.publicOnly && !isAuthenticated) ||
            (link.adminRequired && isAuthenticated && isAdmin) 
          ).map((link) => (
            <Link
              key={link.href}
              href={link.href}
              className={cn(
                "text-sm font-medium transition-colors hover:text-primary",
                pathname === link.href ? "text-primary" : "text-foreground/70"
              )}
            >
              {/* Special case for Admin link to use UserCog icon */}
              {link.label === "Admin" && link.adminRequired && isAuthenticated && isAdmin ? (
                <>
                  <UserCog className="mr-1 h-4 w-4 inline-block" /> {link.label}
                </>
              ) : (
                link.label
              )}
            </Link>
          ))}
          {isAuthenticated ? (
            <Button variant="ghost" size="sm" onClick={handleLogout}>
              <LogOut className="mr-2 h-4 w-4" />
              Logout
            </Button>
          ) : (
            pathname !== '/auth/login' && pathname !== '/auth/register' && (
               <Button asChild variant="ghost" size="sm">
                 <Link href="/auth/login">
                   <LogIn className="mr-2 h-4 w-4" /> Login
                 </Link>
               </Button>
            )
          )}
        </nav>
      </div>
    </header>
  );
}
